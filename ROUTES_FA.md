# راهنمای API سرویس OCR

سرویس OCR برای استخراج متن از تصاویر و فایل‌های PDF

## نقاط پایانی (Endpoints)

### ۱. استخراج متن از تصویر

```
POST /ocr-image/
```

پارامترهای درخواست:
```json
{
    "image": "فایل تصویر",
    "title": "عنوان تصویر (اجباری)",
    "user_id": "شناسه کاربر (اجباری)"
}
```

پاسخ موفق:
```json
{
    "id": 1,
    "text": "متن استخراج شده از تصویر",
    "image_url": "/media/ocr_images/image.jpg",
    "title": "عنوان تصویر",
    "created_at": 1672531200,
    "user_id": "شناسه کاربر",
    "processing_time": "1.25s"
}
```

پاسخ موفق نسبی (در صورت خطای OCR):
```json
{
    "id": 1,
    "error": "OCR processing failed: [دلیل خطا]",
    "image_url": "/media/ocr_images/image.jpg",
    "title": "عنوان تصویر",
    "created_at": 1672531200,
    "user_id": "شناسه کاربر",
    "message": "Image saved successfully but OCR processing failed. You can try again later."
}
```

### ۲. استخراج متن از PDF

```
POST /ocr-pdf/
```

پارامترهای درخواست:
```json
{
    "pdf": "فایل PDF",
    "title": "عنوان فایل (اجباری)",
    "user_id": "شناسه کاربر (اجباری)"
}
```

پاسخ موفق:
```json
{
    "id": 2,
    "pages": [
        {
            "page": 1,
            "text": "متن صفحه اول"
        },
        {
            "page": 2,
            "text": "متن صفحه دوم"
        }
    ],
    "title": "عنوان فایل",
    "created_at": 1672531200,
    "user_id": "شناسه کاربر",
    "processing_time": "2.34s"
}
```

پاسخ موفق نسبی (در صورت خطا در برخی صفحات):
```json
{
    "id": 2,
    "pages": [
        {
            "page": 1,
            "text": "متن صفحه اول"
        },
        {
            "page": 2,
            "text": "",
            "error": "Error processing page"
        }
    ],
    "title": "عنوان فایل",
    "created_at": 1672531200,
    "user_id": "شناسه کاربر",
    "processing_time": "2.34s",
    "message": "1 of 2 pages processed successfully"
}
```

### ۳. دریافت پست‌های کاربر

```
GET /user-posts/?user_id=user123&timestamp=1672531200
```

پارامترهای درخواست:
- `user_id`: شناسه کاربر (اجباری) - فقط پست‌های متعلق به این کاربر برگردانده می‌شوند
- `timestamp`: زمان به فرمت Unix timestamp (اجباری)

پاسخ:
```json
{
    "posts": [
        {
            "id": 1,
            "title": "عنوان تصویر",
            "extracted_text": "متن استخراج شده",
            "created_at": 1672531200,
            "image_url": "/media/ocr_images/image.jpg"
        },
        {
            "id": 2,
            "title": "عنوان PDF",
            "extracted_text": "متن استخراج شده از تمام صفحات",
            "created_at": 1672617600,
            "image_url": null
        }
    ]
}
```

## ویژگی‌های خاص

### مدیریت عناوین تکراری

در صورتی که عنوان تکراری برای یک کاربر وجود داشته باشد، سیستم به طور خودکار یک شماره در پرانتز به انتهای عنوان اضافه می‌کند:

- عنوان اصلی: "عنوان من"
- اگر تکراری باشد: "عنوان من (۱)"
- اگر باز هم تکراری باشد: "عنوان من (۲)"

### امنیت و جداسازی داده‌های کاربران

هر کاربر فقط به داده‌های خود دسترسی دارد و فیلد `user_id` برای تمام درخواست‌ها اجباری است. این باعث می‌شود:
- کاربران نتوانند به پست‌های یکدیگر دسترسی داشته باشند
- از تداخل داده‌ها بین کاربران جلوگیری شود
- هر کاربر فقط پست‌های خود را مشاهده کند

### فرمت زمان

تمامی زمان‌ها در پاسخ‌های API به فرمت Unix timestamp (ثانیه از مبدأ زمان) ارسال می‌شوند.

### مدیریت خطا و بازیابی

سیستم دارای مکانیزم بازیابی خطا است که در صورت بروز مشکل در پردازش OCR، فایل اصلی را ذخیره می‌کند و امکان تلاش مجدد را فراهم می‌کند. در صورت خطا، کد وضعیت HTTP 206 (Partial Content) برگردانده می‌شود.

### پردازش دسته‌ای فایل‌های PDF

برای فایل‌های PDF بزرگ، سیستم از پردازش دسته‌ای استفاده می‌کند تا مصرف حافظه را بهینه کند. هر دسته شامل تعداد مشخصی صفحه است که به صورت موازی پردازش می‌شوند.

### محدودیت نرخ درخواست

برای جلوگیری از حملات DoS، سیستم دارای محدودیت نرخ درخواست است:
- کاربران ناشناس: ۱۰ درخواست در دقیقه
- کاربران شناسایی شده: ۳۰ درخواست در دقیقه

## محدودیت‌ها

### محدودیت‌های فایل تصویر
- فرمت‌های مجاز: JPG، JPEG، PNG
- حداکثر حجم فایل: بر اساس تنظیمات سرور (UPLOAD_IMAGE_SIZE_LIMIT_MB)

### محدودیت‌های فایل PDF
- فرمت مجاز: PDF
- حداکثر حجم فایل: بر اساس تنظیمات سرور (PDF_SIZE_LIMIT_MB)
- حداکثر تعداد صفحات: بر اساس تنظیمات سرور (PDF_PAGE_LIMIT)

## کدهای خطا

### کدهای وضعیت HTTP
- `200`: درخواست موفق
- `201`: ایجاد موفق
- `206`: محتوای نسبی (در صورت موفقیت نسبی)
- `400`: پارامترهای نامعتبر
- `429`: تعداد درخواست‌ها بیش از حد مجاز
- `500`: خطای داخلی سرور

### خطاهای خاص
- فایل نامعتبر: "نوع فایل تصویر معتبر نیست"
- حجم بیش از حد: "حجم فایل نباید بیشتر از X مگابایت باشد"
- تعداد صفحات بیش از حد: "تعداد صفحات نباید بیشتر از X باشد"
- زمان نامعتبر: "فرمت زمان نامعتبر است. از Unix timestamp استفاده کنید"
- شناسه کاربر خالی: "شناسه کاربر نمی‌تواند خالی باشد"
- عنوان خالی: "عنوان نمی‌تواند خالی باشد" 